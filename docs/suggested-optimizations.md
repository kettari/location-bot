# Предложения по оптимизации (на основе анализа проекта)

Ниже — практичные улучшения без изменения функциональности. Сгруппированы по темам; каждая включает суть, ожидаемый эффект и краткие шаги реализации.

## Производительность и надежность

- ✅ Конфигурируемый HTTP-клиент с таймаутами и лимитами
  - Эффект: снижение зависаний и утечек ресурсов при сетевых проблемах.
  - Шаги: создать `http.Client` с `Timeout`, пулами соединений в `Transport`; использовать его в `scraper.Page` и `scraper.Events`.
  - **Реализовано**: создан `internal/scraper/http_client.go` с конфигурацией timeout (15s), connection pooling, HTTP/2. Используется в `page.go` и `events.go`.

- Повторные попытки (retry) с экспоненциальной задержкой и джиттером
  - Эффект: устойчивость к временным сбоям Rolecon.ru.
  - Шаги: обернуть вызовы HTTP в retry (например, до 3 попыток) с backoff и джиттером; различать коды 4xx/5xx.

- Отмена по контексту для всех сетевых/БД операций
  - Эффект: предсказуемое завершение worker pool и CLI команд; отсутствие «висячих» горутин.
  - Шаги: прокидывать `context.Context` из команд в `scraper`, `parser`, `schedule`, `storage`.

- Границы worker pool и управление очередью
  - Эффект: контролируемое использование CPU/сети/Rolecon API.
  - Шаги: параметризовать `workersCount`; на входе ограничивать количество URL (rate limiting), добавив небольшую задержку между заданиями.

## Архитектура и качество кода

- ✅ Разделение ответственности: вынести сбор CSRF и загрузку Events в сервис-уровень
  - Эффект: лучшая тестируемость, явные границы между `scraper` и «use case» (командой).
  - Шаги: ввести слой `internal/scraper/fetcher.go` (сервис) для сценария загрузки.
  - **Реализовано**: создан `Fetcher` сервис в `internal/scraper/fetcher.go` для инкапсуляции логики CSRF и событий. Команда `schedule:fetch` делегирует работу сервису через обратный вызов для параллельной загрузки страниц.

- Инверсия зависимостей для Telegram бота
  - Эффект: легче тестировать уведомления; возможность подменять транспорт (mock/другая платформа).
  - Шаги: прокидывать `entity.MessageDispatcher` из команд/сервисов через конструктор.

- Введение «часов» (Clock) как зависимости
  - Эффект: детерминированные тесты дат и времени.
  - Шаги: обернуть `time.Now()` в интерфейс, внедрять через конструкторы `HtmlEngine`, `Game`, `Schedule`.

- Исправить инвертированную проверку ошибок в Observers
  - Эффект: корректное логирование неудачных отправок.
  - Шаги: в `NewGameObserver/BecomeJoinable/Cancelled` заменить `if err == nil { slog.Error(...) }` на `if err != nil { ... }`.

## Безопасность и конфигурация

- Не логировать секреты из конфигурации
  - Эффект: исключение утечки токенов/строк подключения.
  - Шаги: убрать значения токенов из `slog.Debug` в `config.GetConfig()`; оставлять только факты наличия/валидации.

- Отказ от `os.Exit` вне CLI слоя
  - Эффект: предсказуемое управление ошибками; лучшая тестируемость.
  - Шаги: возвращать ошибки из `config.GetConfig()`; завершать процесс в `cmd/console/main.go`.

- Валидация конфигурации получателей уведомлений
  - Эффект: предотвращение падений при некорректных `chat_id,thread_id`.
  - Шаги: проверять длину пар, числовые значения; логировать Warn и пропускать некорректные записи.

## Наблюдаемость и эксплуатация

- Метрики и трассировка
  - Эффект: видимость задержек/ошибок (HTTP, parsing, DB, отправка в Telegram).
  - Шаги: добавить счетчики/таймеры (Prometheus/OpenTelemetry), кореляционные поля в логи (request_id).

- Структура логов и уровни
  - Эффект: проще фильтровать и анализировать инциденты.
  - Шаги: выровнять уровни (Info/Warn/Error), убрать шумные Debug в проде через конфиг.

## База данных и данные

- Индексы для частых запросов
  - Эффект: ускорение выборок расписания.
  - Шаги: убедиться в наличии индексов по `date`, `joinable`, `external_id`.

- Управление пулом соединений GORM
  - Эффект: стабильность под нагрузкой.
  - Шаги: настроить `SetMaxOpenConns`, `SetMaxIdleConns`, `SetConnMaxLifetime` через `sql.DB` из `gorm.DB`.

- Атомарность обновлений и генерация событий
  - Эффект: устранение гонок условий при записи и проверке событий.
  - Шаги: обернуть поиск-обновление-решение о событии в транзакцию; при необходимости использовать `SELECT ... FOR UPDATE`.

## Доставка в Telegram

- Rate limiting и пакетная отправка
  - Эффект: снижение риска 429/ошибок доставку; экономия запросов.
  - Шаги: добавить локальный лимитер (token bucket), отправлять батчами, объединять несколько уведомлений в одно при близких во времени событиях.

- Идемпотентность уведомлений
  - Эффект: отсутствие дублей сообщений при повторных запусках.
  - Шаги: хранить «последнее отправленное состояние» или хэш уведомления; пропускать повторную отправку.

## Тестирование

- Покрытие ключевых кейсов парсера таблицами тестов
  - Эффект: устойчивость к изменениям HTML.
  - Шаги: unit-тесты `HtmlEngine` с фикстурами из `docs/webpage-examples`.

- Интеграционные тесты scraper/CSRF с `httptest`
  - Эффект: гарантии корректности сетевого слоя без внешних зависимостей.
  - Шаги: мок-сервер, сценарии 200/404/429/5xx.

- Тесты диспетчера worker pool
  - Эффект: верификация распределения, обработки ошибок, отмены по контексту.
  - Шаги: тесты с искусственными задержками/ошибками, проверка `errorFlag` и сборщика.

## DX и эксплуатация

- Конфиг через `.env` + схемная валидация
  - Эффект: удобство локальной разработки, явные ошибки конфигурации.
  - Шаги: поддержать загрузку `.env` (только локально), валидировать схему конфигурации.

- Документация сценариев и SLA
  - Эффект: прозрачность ожиданий и ответственности.
  - Шаги: описать RPO/RTO для `schedule:fetch`, частоту запуска, поведение при сбоях.
