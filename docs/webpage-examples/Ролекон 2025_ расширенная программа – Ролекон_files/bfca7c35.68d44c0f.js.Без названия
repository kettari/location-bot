try{(self.webpackChunkvkweb=self.webpackChunkvkweb||[]).push([[87341],{823957:(e,t,o)=>{o.d(t,{Upload:()=>R,jsonpManager:()=>O});var i=o(754866),n=o(972332),a=o(270959),s=o(898848),l=o(478752),r=o(101272),d=o(636576),u=o(952661),p=o(226220),c=o(330882),h=o(261910),g=o(866467),f=o(469004),_=o(969686),m=o(246429),b=o(237625),S=o(375512),k=o(395846),U=o(957994),C=o(873900),v=o(468073),y=o(57626),w=o(615650),x=o(596181),T=o(540462),E=o(826619),P=o(856289);const L=new x.DevNullStatCollector(new x.CustomStatCollector),O={c:1,h:{},reg:function(e){return O.h[O.c]=(0,s.isFunction)(e)?e:function(){},O.c++}},R={init:function(e,t,n,a){o._dG("uploadInterface",void 0!==window.uploadInterface?window.uploadInterface+1:0);let l=window.uploadInterface;return(0,s.each)(["obj","dropbox","options","vars","types","uploadUrls","callbacks","checks","dragTimer","sessions","files"],(function(e,t){R[t]||(R[t]={})})),this.obj[l]=(0,i.ge)(e),a.dropbox&&(this.dropbox[l]=(0,i.ge)(a.dropbox)),this.vars[l]=n,a.file_input=(0,i.ge)(a.file_input),this.options[l]=a,a.clear&&window.cur.destroy.push(R.deinit.pbind(l)),this.uploadUrls[l]=t,a.customShowProgress?a.customShowProgress():this.obj[l]&&("INPUT"!==this.obj[l].tagName||this.checkFileApi()?this.obj[l].innerHTML='<div class="upload_check loading">'+(0,p.getProgressHtml)("","pr_medium upload_pr")+"</div>":this.obj[l]=(0,i.ge)(a.fieldEl)||this.obj[l].parentNode.firstChild),a.noCheck?this.embed(l):this.check(l),l},deinit:function(e){if(!R.obj[e])return;let t=(R.options[e]||{}).dragEvObj;if(t&&((0,n.removeEvent)(t,"dragenter"),(0,n.removeEvent)(t,"dragover"),(0,n.removeEvent)(t,"dragleave")),(0,s.each)(["obj","dropbox","options","vars","types","uploadUrls","callbacks"],(function(t,o){R[o]&&delete R[o][e]})),R.callbacks){let t=["oncheck","ondone","onfail"];(0,s.each)(R.flashCallbacks(),(function(e,o){t.push(e)})),(0,s.each)(t,(function(t,o){delete R.callbacks[o+e]}))}clearTimeout(R.checks["timer"+e]),clearTimeout(R.dragTimer[e]),delete R.dragTimer[e]},check:function(e){let t=this.obj[e],o=this.vars[e],n=this.options[e],a=n.check_url?n.check_url:this.uploadUrls[e],s={};if(n.signed){if(!a)return R.onCheckComplete(e);(0,l.extend)(s,{_jsonp:O.reg((function(t){R.onCheckComplete(e,t)}))})}else{if(!n.check_hash&&!n.server)return R.onCheckComplete(e);if(n.use_go_uploader)return R.onCheckComplete(e);this.callbacks["oncheck"+e]=R.onCheckComplete.pbind(e);let t=["mid","aid","gid","hash","rhash"];for(let e in t)t.hasOwnProperty(e)&&(s[t[e]]=o[t[e]]);n.check_aid&&(s.aid=n.check_aid),n.check_gid&&(s.gid=n.check_gid),n.check_hash&&(s.hash=n.check_hash),n.check_rhash&&(s.rhash=n.check_rhash),o.https_resp&&(s.https_resp=o.https_resp),(0,l.extend)(s,{al:1,act:"check_upload",type:n.type,ondone:"Upload.callbacks.oncheck"+e})}let r='<form action="'+a+'" enctype="multipart/form-data" method="post" id="check_upload_form'+e+'" target="check_iframe'+e+'">';for(let e in s)s.hasOwnProperty(e)&&(r+='<input type="hidden" name="'+e+'" value="'+s[e]+'" />');r+='</form><iframe style="visibility: hidden; width: 1px; height: 1px;" id="check_iframe'+e+'" name="check_iframe'+e+'"></iframe>';let d=(0,i.ce)("div",{id:"check_upload_"+e,innerHTML:r,className:n.checkClass||""},{display:"none"});(0,i.ge)("check_upload_"+e)&&(0,i.re)("check_upload_"+e),t.appendChild(d);let u=(0,i.ge)("check_upload_form"+e);if(!u)return;if(!(0,P.isVideoStandalone)()){try{u&&u.submit(),clearTimeout(R.checks["timer"+e]),this.checks["timer"+e]=setTimeout(R.serverFail.pbind(e),1e4)}catch(e){(0,b.debugLog)(e)}return}const p=document.getElementById("check_upload_"+e),c=new FormData;[...p.querySelectorAll("input")].forEach((e=>{c.append(e.name,e.value)})),fetch(a,{method:"POST",body:c}).then((()=>R.callbacks["oncheck"+e]()))},onCheckComplete:function(e,t){clearTimeout(R.checks["timer"+e]),delete R.checks["timer"+e];let o={},i=R.options[e],n=t;if(i.signed)o=(0,h.parseJSON)(t||"{}");else{t=(t=t||"").split("&");for(let e in t)if(t.hasOwnProperty(e)){let i=t[e].split("=");o[i[0]]=i[1]}n=o}i.customHideProgress&&i.customHideProgress(),o.error||o.fail?R.serverFail(e,n):(i.noCheck=1,i.onCheckComplete?i.onCheckComplete(e):R.embed(e),R.serverSuccess(e,n))},serverFail:function(e,t){let o=R.obj[e],i=R.options[e],n=R.vars[e];if(!o)return;if(!i.signed&&!i.server)return;if(R.fails||(R.fails={}),R.fails[e]=R.fails[e]?R.fails[e]+1:1,i.signed){let n=R.uploadUrls[e].split("?"),s=(0,_.fromQueryString)(n[1]),r=(0,l.extend)({act:"check_result",_resign:s._query||n[1]},t?{_query:t}:{_check:i.check_url.split("?")[1]});return void window.ajax.post("upload_fails.php",r,{onDone:function(t,n,s,r){R.fails[e]<i.max_attempts?(R.uploadUrls[e]=t,(0,l.extend)(R.options[e],{check_url:n,base_url:s,static_url:r}),R.check(e)):(o.innerHTML="",i.lang&&i.lang.cannot_upload_title&&i.lang.cannot_upload_text&&(0,a.showFastBox)({title:i.lang.cannot_upload_title,width:430,bodyStyle:"padding: 20px; line-height: 160%;"},i.lang.cannot_upload_text))}})}let s=(0,l.extend)({act:"fail",role:i.type,mid:n.mid,oid:n.oid,gid:n.gid,aid:n.aid,server:i.server,st2_server:i.st2_server,error:i.error,hash:i.error_hash,hash_extra:n.hash_extra},t);i.custom_hash&&(0,l.extend)(s,{custom_hash:i.custom_hash,photo_hash:n.photo_hash,size:n.size,fid:n.fid,vid:n.vid,tag:n.tag}),n.transform_entry&&(0,l.extend)(s,{transform_entry:n.transform_entry,transform_hash:n.transform_hash,security_hash:n.security_hash}),window.ajax.post("upload_fails.php",s,{onDone:function(t,n,s){R.fails[e]<i.max_attempts?(R.uploadUrls[e]=t,(0,l.extend)(R.options[e],s),(0,l.extend)(R.vars[e],n),R.check(e)):(o.innerHTML="",i.lang&&i.lang.cannot_upload_title&&i.lang.cannot_upload_text&&(0,a.showFastBox)({title:i.lang.cannot_upload_title,width:430,bodyStyle:"padding: 20px; line-height: 160%;"},i.lang.cannot_upload_text))}})},serverSuccess:function(e,t){let o=R.options[e],i=R.vars[e];if(R.checked=R.checked||{},R.checked[e]=1,o.signed)return void window.ajax.post("upload_fails.php",{act:"check_result",_query:t});if(!o.server&&!o.error_hash)return;let n=(0,l.extend)({act:"success",mid:i.mid,oid:i.oid,gid:i.gid,aid:i.aid,server:o.server,error:o.error,hash:o.error_hash},t);window.ajax.post("upload_fails.php",n)},embed:function(e){let t=null!=e.num?e.num:e,o=this.obj[t],n=this.dropbox[t],a=this.options[t];a.noEmbed?(0,i.re)("check_upload_"+e):a.noCheck&&o&&(this.checkFileApi()?this.initFileApi(t,o,n):a.noForm||this.initForm(t,o))},checkFileApi:()=>(window.XMLHttpRequest||window.XDomainRequest)&&(window.FormData||window.FileReader&&(window.XMLHttpRequest&&XMLHttpRequest.sendAsBinary||window.ArrayBuffer&&window.Uint8Array&&(window.MozBlobBuilder||window.WebKitBlobBuilder||window.BlobBuilder))),initForm:function(e,t){let o=e,n=this.vars[o],a=this.options[o];this.types[o]="form";let s='<form action="'+this.uploadUrls[o]+'" enctype="multipart/form-data" method="post" id="file_uploader_form'+o+'" target="upload_iframe'+o+'" style="text-align: center; width: 100%;">';if(a.signed)(0,l.extend)(n,{_jsonp:O.reg((function(e){R.onUploadComplete(o,e)}))});else{let e=R.onUploadComplete.pbind(o),t=R.onUploadError.pbind(o);this.callbacks["ondone"+o]=function(){let t=e.pbind.apply(e,arguments);setTimeout((function(){t()}),1)},this.callbacks["onfail"+o]=function(){let e=t.pbind.apply(t,arguments);setTimeout((function(){e()}),1)},(0,l.extend)(n,{al:1,ondone:"Upload.callbacks.ondone"+o,onfail:"Upload.callbacks.onfail"+o})}for(let e in n)n.hasOwnProperty(e)&&(s+='<input type="hidden" name="'+e+'" value="'+n[e]+'" />');let r='<input type="file" class="file" size="28" onchange="'+(a.uploadButton?"Upload.onUploadFileSelected("+o+")":"Upload.onUploadStart("+o+");")+'" name="'+a.file_name+'" style="cursor: pointer;"'+(a.accept?' accept="'+a.accept+'"':"")+'/></form><iframe style="position: absolute; visibility: hidden; width: 1px; height: 1px;" id="upload_iframe'+o+'" name="upload_iframe'+o+'"></iframe>';a.label?s+=a.label.split("{file}").join(r):s+=r,t.innerHTML=s;let d=a.file_input,u=(0,i.geByClass1)("file",t,"input");delete a.file_input,d&&u&&(u.parentNode.replaceChild(d,u),d.onchange=function(){R.onUploadStart(o)},(0,i.data)(d,"changed")&&((0,i.data)(d,"changed",!1),d.onchange())),a.uploadButton&&a.setUploadAction?a.setUploadAction(e,(function(){R.onUploadStart(o)})):a.uploadButton&&!0!==a.uploadButton&&((0,i.ge)(a.uploadButton).onclick=function(){R.onUploadStart(o)})},buttonOver:function(e){(0,i.addClass)((0,i.ge)("lite_upload"+e).nextSibling,"hover")},buttonOut:function(e){(0,i.removeClass)((0,i.ge)("lite_upload"+e).nextSibling,"hover"),(0,i.removeClass)((0,i.ge)("lite_upload"+e).nextSibling,"active")},buttonDown:function(e){(0,i.addClass)((0,i.ge)("lite_upload"+e).nextSibling,"active")},buttonUp:function(e){(0,i.removeClass)((0,i.ge)("lite_upload"+e).nextSibling,"active")},initFileApi:function(e,t,o){let a,s=this.options[e],l=s&&s.dragEl||window.boxLayerWrap;if(o&&l&&(R.addedDocEvent||((0,n.addEvent)(document,"drop",R.drop),R.addedDocEvent=!0),s.dragEvObj=l,(0,n.addEvent)(l,"dragenter",R.dragEnter.pbind(e)),(0,n.addEvent)(l,"dragover",R.dragOver.pbind(e)),(0,n.addEvent)(l,"dragleave",R.dragOut.pbind(e))),this.types[e]="fileApi",s.chooseBox)a='<input class="file" type="file" size="28" onchange="Upload.onFileApiSend('+e+', this.files);"'+(s.multiple?' multiple="true"':"")+(s.accept?' accept="'+s.accept+'"':"")+' name="'+s.file_name+'" style="cursor: pointer;"/>';else if(s.uploadButton)s.lang.button_browse||(s.lang.button_browse="Выбрать файл"),a='<button class="flat_button upload_btn fl_l '+(s.buttonClass||"")+'" onclick="this.nextSibling.nextSibling.click()">'+s.lang.button_browse+'</button><div class="upload_selected fl_l" style="padding: 4px 0 0 10px;"></div><input class="file" type="file" size="28" onchange="geByClass1(\'upload_selected\', this.parentNode).innerHTML = Upload.getFilesNames('+e+", this.files); Upload.onUploadFileSelected("+e+')"'+(s.multiple?' multiple="true"':"")+(s.accept?' accept="'+s.accept+'"':"")+' name="'+s.file_name+'" style="visibility: hidden; position: absolute;"/><br class="clear" />';else if(s.lang.button_browse||(s.lang.button_browse="Выбрать файл"),s.flat_button){const t=u.FlatButton.render({className:"upload_btn"+(s.buttonClass||""),appearance:u.FlatButtonAppearance.PRIMARY,size:u.FlatButtonSize.M,children:s.lang.button_browse,restAttrs:{onclick:"document.querySelector('.flat_button_file').click()"}}),o=`<input class="file flat_button_file" type="file" size="28"\n                     onchange="Upload.onFileApiSend('${e}', this.files);" ${s.multiple?' multiple="true"':""} ${s.accept?' accept="'+s.accept+'"':""} name="${s.file_name}" style="visibility: hidden; position: absolute;"/>\n                `,i=document.createElement("div");i.appendChild(t),i.insertAdjacentHTML("beforeend",o),a=i.innerHTML}else a='<button class="flat_button upload_btn '+(s.buttonClass||"")+'" onclick="this.nextSibling.click()">'+s.lang.button_browse+'</button><input class="file" type="file" size="28" onchange="Upload.onFileApiSend('+e+', this.files);"'+(s.multiple?' multiple="true"':"")+(s.accept?' accept="'+s.accept+'"':"")+' name="'+s.file_name+'" style="visibility: hidden; position: absolute;"/>';s.label&&!s.flat_button?t.innerHTML=s.label.split("{file}").join(a):t.innerHTML=a;let r=s.file_input,d=(0,i.geByClass1)("file",t,"input");r&&d&&(d.parentNode.replaceChild(r,d),r.onchange=function(){R.onFileApiSend(e,this.files)},(0,i.data)(r,"changed")&&((0,i.data)(r,"changed",!1),setTimeout(r.onchange.bind(r),0))),s.uploadButton&&s.setUploadAction?s.setUploadAction(e,(function(){R.onFileApiSend(e,(0,i.geByTag1)("input",t).files)})):s.uploadButton&&!0!==s.uploadButton&&((0,i.ge)(s.uploadButton).onclick=function(){R.onFileApiSend(e,(0,i.geByTag1)("input",t).files)})},switchMode:function(e){R.options[e].noCheck=1,R.embed(e)},onUploadFileSelected:function(e){R.options[e].onUploadFileSelected&&R.options[e].onUploadFileSelected()},onUploadStart:function(e,t){window.cur.fileApiUploadStarted=!0;let o=void 0!==e.ind?e.ind:e;if("form"==R.types[o]){(0,i.ge)("file_uploader_form"+o).submit(),(0,i.geByClass1)("file",R.obj[o]).disabled=!0}let n=R.options[o];n.eventCallbacks?.onUploadStart?.(e,t),n.onUploadStart&&(n.isNeedCheckClipOrVideo&&!n.isShort&&!n.is_private_owner&&(0,T.partConfigEnabled)("clips_publish_videos_to_clips_web")?(0,T.partConfigEnabled)("video_uploader_disable_publish_button_when_no_metadata")?this.checkFileParams(e.file,n.clips_from_video_duration_min_limit,n.clips_from_video_duration_max_limit).then((({hasMetadata:o,isVideoAsClip:i})=>{n.onUploadStart({...e,is_upload_clip_from_video:i,is_no_metadata:!o},t)})):this.checkShortVideoAspectRatio([e.file],n.clips_from_video_duration_min_limit,n.clips_from_video_duration_max_limit).then((o=>{n.onUploadStart({...e,is_upload_clip_from_video:o},t)})):n.onUploadStart(e,t))},getErrorAdditional:function(e){return e.error&&void 0!==e.server&&void 0!==e.bwact?(-1!==e.error.indexOf(":")?",":":")+" from upl_"+(0,s.intval)(e.server)+"?act="+e.bwact.replace(/[^a-zA-Z_0-9]/g,""):""},onUploadComplete:function(e,t,o){let n,a=void 0!==e.ind?e.ind:e,s=R.options[a];if(void 0!==o&&a===e&&(e=o),"object"==typeof e&&(e.ind=a),"form"==R.types[a]){(0,i.geByClass1)("file",R.obj[a]).disabled=!1}if(s.onUploadComplete){const o=o=>{let i="";s.signed&&(n=o?(0,h.parseJSON)(o):"",n?i=R.getErrorAdditional(n):o='{"error":"ERR_CLIENT_UPLOAD_FAIL: upload request bad result, url \\"'+R.uploadUrls[a]+'\\""}'),s.onUploadComplete(e,o,i),"form"===R.types[a]&&R.onUploadCompleteAll(e,o),s.eventCallbacks?.onUploadComplete?.(e,t)};s.useGoUploader&&s.forPlaylist?window.ajax.post("/al_video.php",{act:s.isVertical?"do_save_loaded_playlist_vertical_thumb":"do_save_loaded_playlist_thumb",owner_id:R.vars[a].owner_id,thumb_size:R.vars[a].thumb_size,thumb:t},{onDone:e=>o(JSON.stringify(e)),onFail:()=>(o(),!1)}):s.useGoUploader&&!s.forPlaylist?(0,U.api)("video.saveUploadedThumb",{owner_id:R.vars[a].owner_id,thumb_json:t,thumb_size:R.vars[a].thumb_size,random_tag:R.vars[a].random_tag}).then((e=>o(JSON.stringify(e)))).catch((()=>o())):o(t)}"video"===s.type?(0,d.statlogsValueEvent)("upload_video_fails",1,s.server,"success"):"photo"===s.type?(0,d.statlogsValueEvent)("upload_photo_fails",1,s.server,"success"):"doc"===s.type&&(0,d.statlogsValueEvent)("upload_doc_fails",1,s.server,"success")},onUploadCompleteAll:function(e,t,o){let n=void 0!==e.ind?e.ind:e,a=R.options[n];if(void 0!==o&&n===e&&(e=o),"fileApi"===R.types[n]){let e=(0,i.geByClass1)("file",R.obj[n],"input");e&&(e.value="")}let s={duration:Date.now()-a.uploadStartedTs,type:a.type,total_size:a.filesTotalSize};"subtitles"!==a.type&&this.sendUploadStat(n,s),a.onUploadCompleteAll&&a.onUploadCompleteAll(e,t)},onUploadError:function(e,t){let o=void 0!==e.ind?e.ind:e,n=R.options[o]||{};if("form"===R.types[o]){(0,i.geByClass1)("file",R.obj[o]).disabled=!1}n.signed?n.onUploadComplete&&n.onUploadComplete(e,'{"error":"ERR_CLIENT_UPLOAD_FAIL: upload request fail, code \\"'+t.replace(/([\\\"])/g,"\\$1").replace(/\n/g,"\\n")+'\\", url \\"'+R.uploadUrls[o]+'\\""}'):n.onUploadError&&n.onUploadError(e,t),n.eventCallbacks?.onUploadError?.(e,t)},onConnectionLost:function(e){let t=void 0!==e.ind?e.ind:e,o=R.options[t];o.onConnectionLost&&o.onConnectionLost(e)},onUploadProgress:function(e,t,o){let i=void 0!==e.ind?e.ind:e,n=R.options[i];n.onUploadProgress&&n.onUploadProgress(e,t,o)},onDebug:function(e,t){let o=void 0!==e.ind?e.ind:e,i=R.options[o];i.onDebug&&i.onDebug(e,t)},onSelectClick:function(e,t){let o=void 0!==e.ind?e.ind:e,i=R.options[o];i.onSelectClick&&i.onSelectClick(e,t)},getFilesNames:function(e,t){if(!t||!t.length)return;let o=this.options[e];return o.multiple?(o.lang.selected_num_files||(o.lang.selected_num_files=["","%s файл","%s файла","%s файлов"]),(0,g.langNumeric)(t.length,o.lang.selected_num_files)):t[0].name.replace(/[&<>"']/g,"")},checkFileType:function(e,t,o){let i=!1;if(o&&""!==o){let t=!0;if((0,s.each)(o.split(";"),(function(o,i){if(i=i.substr(1).toLowerCase(),e.substr(-i.length).toLowerCase()==i)return t=!1,!1})),!t)return!1}return(0,s.each)(t.split(";"),(function(t,o){if(o=o.substr(1).toLowerCase(),e.substr(-o.length).toLowerCase()==o||".*"==o)return i=!0,!1})),i},checkFilesSizes:function(e,t){let o=this.options[e];if(o.forPlaylist&&o.useGoUploader)return!0;if(o.file_size_limit)for(let i in t)if(t.hasOwnProperty(i)){let n=t[i];if(n.size&&n.size>o.file_size_limit){let t=o.lang.filesize_error;return t&&t.indexOf("{count}")>=0&&(t=o.file_size_limit>=1048576?t.replace("{count}",(0,s.intval)(o.file_size_limit/1048576)):t.replace("{count}",(0,s.intval)(o.file_size_limit/1024))),t&&(0,a.showFastBox)({title:(0,g.getLang)("global_error"),width:430,bodyStyle:"padding: 20px; line-height: 160%;",onHide:function(){R.embed(e),delete cur.notStarted}},t,(0,g.getLang)("global_cancel")),!1}}return!0},checkFilesDuration:async function(e,t=0,o=0){if(t||o)for(let i in e)if(e.hasOwnProperty(i)){let n=e[i];const s=await(0,y.getVideoMetadata)(n);if(null!==s&&(s.duration>o||s.duration<t))return(0,a.showFastBox)({title:(0,g.getLang)("global_error"),width:430,bodyStyle:"padding: 20px; line-height: 160%;"},(0,g.getLang)("video_clip_duration_limit_text_1s"),(0,g.getLang)("global_close")),!1}return!0},checkFileParams:async function(e,t=0,o=0){const i=await(0,y.getVideoMetadata)(e);return{hasMetadata:!!i&&"duration"in i&&"height"in i&&"width"in i,isVideoAsClip:i&&i.width<i.height&&i.duration<o&&i.duration>t}},checkShortVideoAspectRatio:async function(e,t=0,o=0){if(o)for(let i in e)if(e.hasOwnProperty(i)){let n=e[i];const a=await(0,y.getVideoMetadata)(n);if(a&&a.width<a.height&&a.duration<o&&a.duration>t)return!0}return!1},checkClipSize:async function(e,t=0){if(t){const o=e[0].size;if(o&&o>t)return(0,a.showFastBox)({title:(0,g.getLang)("global_notify_error_occured"),width:430,bodyStyle:"padding: 20px; line-height: 160%;"},(0,g.getLang)("video_clip_size_limit_text_8gb"),(0,g.getLang)("video_clip_size_limit_ok_btn")),!1}return!0},onFileApiSend:async function(e,t,o){if(!t||!t.length)return;let i=this.options[e];if(i.isShort&&(0,d.statlogsValueEvent)("clips_uploader",1,"upload_file"),i.file_types){let e=[];if((0,s.each)(t,(function(t,o){R.checkFileType(o.name,i.file_types,i.file_disallowed_types)&&e.push(o)})),!e.length)return void(i.onNoFilteredCallback&&i.onNoFilteredCallback(t));t=e}if(i.filterCallback&&!(t=i.filterCallback(e,t)).length)return;if(i.reverse_files&&(t=Array.prototype.slice.call(t).reverse()),!i.multiple&&t.length>1&&(t=[t[0]]),!this.checkFilesSizes(e,t))return;if(i.isShort&&!await this.checkFilesDuration(t,i.clips_duration_min_limit,i.clips_duration_max_limit))return void R.embed(e);if(i.isShort&&!await this.checkClipSize(t,i.clips_size_max_limit))return void R.embed(e);if(!i.isShort&&!i.is_private_owner&&i.isNeedCheckClipOrVideo&&(0,T.partConfigEnabled)("clips_publish_videos_to_clips_web")){if(1===t.length){const o=R.vars[e];if(await this.checkShortVideoAspectRatio([t[0]],i.clips_from_video_duration_min_limit,i.clips_from_video_duration_max_limit)){const e=await(0,E.getOwnerForShortVideo)(o.oid);return(0,E.saveShortVideoData)(t,e),void(0,E.redirectToRedesignedForm)(o.oid)}}await i.getNewClipUploadConfig()}if(i.photoBox&&!o)return R.onPhotoAdd(e,t);if(i.withoutAutoUpload&&!o)return void(i.onFilesSelected&&i.onFilesSelected(e,t));i.beforeUpload&&i.beforeUpload(e),window.cur.notStarted=window.cur.fileApiUploadStarted=!0,i.multi_progress||this.onUploadStart({ind:e,fileName:(t[0].fileName||t[0].name||"").replace(/[&<>"']/g,""),file:t[0]});let n=t.length;if(i.max_files){let o=cur.attachCount;if(!o&&cur.addMedia){let e=-1;for(let t in cur.addMedia)t>e&&(e=t);e>=0&&cur.addMedia[e]&&cur.addMedia[e].attachCount&&(o=cur.addMedia[e].attachCount)}let s=o?o():0,l=(i.max_files_warning||(0,g.getLang)("global_attach_max_n_files",i.max_files)).replace("{count}",i.max_files);i.max_files-s<t.length?(n=i.max_files-s,(0,a.showFastBox)({title:(0,g.getLang)("global_error"),width:430,bodyStyle:"padding: 20px; line-height: 160%;",onHide:function(){R.embed(e),delete cur.notStarted,i.onMaxCount&&i.onMaxCount()}},l,(0,g.getLang)("global_continue"),(function(){R.uploadFiles(e,t,n),i.max_files_hide_last?(0,m.curBox)().hide():(0,m.getBoxQueue)().hideAll()}),(0,g.getLang)("global_cancel"))):(i.force_max_files&&(n=Math.min(n,i.max_files-(cur.savedPhotos||[]).length)),this.uploadFiles(e,t,n))}else this.uploadFiles(e,t,n)},onPhotoAdd:function(e,t){let o=0,n=0;R.fileList=R.fileList||{},R.fileList[e]||(R.fileList[e]=[],R.options[e].onPhotoBox&&(o=!0)),(0,s.each)(t,(function(t,o){n++;let a=R.options[e].photoBox,s=new RegExp("image.*");o.type.match(s),cur.uploaderPhotoId=(cur.uploaderPhotoId||0)+1;let l=cur.uploaderPhotoId;R.fileList[e][l]=o;let r=(0,i.ce)("img"),d=(0,i.ce)("div",{id:"photos_add_item"+l,className:"photos_add_item",innerHTML:'<span class="photos_add_img photos_add_wait" id="photos_add_cont'+l+'" onmouseover="PhotosAdd.thumbOver('+l+', this);" onmouseout="PhotosAdd.thumbOut('+l+');"><span class="photos_add_s" id="photos_add_s'+l+'">&nbsp;</span></span><span class="bg">&nbsp;</span>'});a.appendChild(d);let u=new FileReader;u.onload=function(e){r.src=e.target.result,r.onload=function(){r.onload=!1;let e,t,o={w:r.width,h:r.height};o.w>130&&(e=130/o.w,o.w=130,o.h=parseInt(o.h*e)),o.h>130&&(t=130/o.h,o.h=130,o.w=parseInt(o.w*t));let n=(0,i.ce)("canvas",{width:o.w,height:o.h});n.getContext("2d").drawImage(r,0,0,o.w,o.h);let a=n.toDataURL("image/jpeg");r.src=a;let s=(0,i.ge)("photos_add_s"+l),d=Math.max(o.w,80),u=Math.min(o.h,98);(0,i.setStyle)(s,{width:d,height:u,marginLeft:Math.ceil((130-d)/2)}),s.innerHTML="",s.appendChild(r),r.onload=function(){setTimeout((function(){s.parentNode.className="photos_add_img"}),0),r.onload=!1},R.finishTask()}},R.taskToQ((function(){u.readAsDataURL(o)}))})),o&&n&&R.options[e].onPhotoBox(),R.options[e].onPhotoAdd&&n&&R.options[e].onPhotoAdd()},uploadPhotos:function(e){let t=[],o=R.fileList[e];for(let e in o)o[e]&&t.push((0,l.extend)(o[e],{fileRef:e}));return R.options[e].onUploadStart&&R.options[e].onUploadStart(),!!t.length&&(cur.uploadCount=Math.min(500,t.length),R.uploadFiles(e,t,cur.uploadCount),!0)},taskToQ:function(e){if(R.previewFileQ||(R.previewFileQ=[]),e&&R.previewFileQ.push(e),R.doingQ)return;let t=R.previewFileQ.shift();t&&(R.doingQ=!0,t())},finishTask:function(){setTimeout((function(){R.doingQ=!1,R.taskToQ()}),100)},uploadFiles:function(e,t,o){if(o<=0)return;let i,n=this.options[e],a=n.signed?this.vars[e]:(0,l.extend)(this.vars[e],{ajx:1}),s=0,r=0,d=0,u=0,p=[];if(n.uploading&&(s=n.filesTotalSize||0,r=n.filesTotalCount||0,u=n.filesLoadedCount||0,d=n.filesLoadedSize||0,p=n.filesQueue),n.file_match&&(i=new RegExp(n.file_match,"i")),(0,T.partConfigEnabled)("video_uploader_pass_params_for_logging")&&"add_video"===a.act&&this.vars?.[e]?.oid){const t=(0,C.getIdentityRawId)({id:Date.now(),ownerId:this.vars?.[e]?.oid});(0,l.extend)(this.vars[e],{batchId:t})}let c=!1;for(let a=0;a<o;a++){let o=(t[a].fileName||t[a].name||"").replace(/[&<>"']/g,"");!n.file_match||o.match(i)?(n.multi_progress&&!n.multi_sequence&&this.onUploadStart({ind:e,fileName:o,file:t[a]}),s+=t[a].size,r+=1,p.push(t[a])):c=!0}if(p.reverse(),(0,l.extend)(n,{filesQueue:p,filesTotalSize:s,filesLoadedSize:d,filesLoadedCount:u,filesTotalCount:r,uploadStartedTs:Date.now()}),p.length>0)if(void 0!==window.cur.multiProgressIndex)window.cur.nextQueues||(window.cur.nextQueues=[]),window.cur.nextQueues.push(e);else{let t=(0,_.toQueryString)(a),o=this.uploadUrls[e]?this.uploadUrls[e]+(this.uploadUrls[e].match(/\?/)?"&":"?")+t:"";n.use_go_uploader&&(o=this.uploadUrls[e]),this.uploadFile(e,p.pop(),o),n.multi_progress&&(window.cur.multiProgressIndex=e)}else c&&R.onUploadError(e,"file type not supported")},getFileInfo:function(e,t,o){return t.multi_progress?{ind:e,fileName:o?(o.fileName||o.name||"").replace(/[&<>"']/g,""):"",num:t.filesLoadedCount,totalSize:t.filesTotalSize,loadedSize:t.filesLoadedSize,totalCount:t.filesTotalCount,file:o}:e},supportsChunkedUpload:function(){return!!Blob&&!!(Blob.prototype.webkitSlice||Blob.prototype.mozSlice||Blob.prototype.slice)&&!!FileReader},uploadFileChunkedWithSDK:async function(e,t,o){let i=R.options[e];const n=R.vars[e];let a,s,r,d,u=R.getFileInfo(e,i,t);if(i.multi_sequence&&(window.cur.fileApiUploadStarted=!0),(0,T.partConfigEnabled)("clips_publish_videos_to_clips_web"))if((0,T.partConfigEnabled)("video_uploader_disable_publish_button_when_no_metadata")){const{hasMetadata:e,isVideoAsClip:o}=await this.checkFileParams(t,i.clips_from_video_duration_min_limit,i.clips_from_video_duration_max_limit);a=o,s=!e}else a=await this.checkShortVideoAspectRatio([t],i.clips_from_video_duration_min_limit,i.clips_from_video_duration_max_limit);(0,T.partConfigEnabled)("client_dev_null_video_uploader_errors")&&(d=S.LogLevelEnum.ERROR,r={info:()=>null,warn:()=>null,error:(e,t,o)=>{let i;try{i=JSON.stringify({errorData:t,uploadInfo:o})}catch(e){i=e.toString()}L.logEvent({key:"video_uploader_errors",json:i,value_str:e,value_str2:o.video.id})},debug:()=>null});const p=i.uploaderConfig??{chunkSize:i.chunkSize||k.VIDEO_UPLOAD_CHUNK_SIZE,threadNumber:k.VIDEO_UPLOAD_FILE_THREAD_NUMBER,maxRetryNumber:k.VIDEO_UPLOAD_CHUNK_MAX_RETRY_NUMBER},c=(1e17*Math.random()).toString(16);i.is_upload_clip_from_video=a&&!i.is_private_owner,s&&(i.is_no_metadata=!0);const h=await this.getUploadDetails(t.size,i,n);"video"===i.type&&h?.owner_id&&h?.video_id&&(0,w.sendVideoMetadataStatsBeforeUpload)(t,h.owner_id,h.video_id);const g=S.VideoUploadService.createUploadSession(h.upload_url,t,{...p,logLevel:d,logger:r,headers:{"Session-ID":c},onRestored:e=>{const t=(0,_.fromQueryString)(e.url).vkVideoId;i.onUploadedVideoIdReceived&&i.onUploadedVideoIdReceived(u,t)},onProgress:o=>{(0,l.extend)(u,R.getFileInfo(e,i,t)),R.onUploadProgress(u,o,100)},onSuccess:o=>{i.filesLoadedSize+=t.size,i.filesLoadedCount+=1,(0,l.extend)(u,R.getFileInfo(e,i,t)),R.onUploadComplete(u,JSON.stringify(o));i.filesQueue&&i.filesQueue.length>0?R.uploadFile(e,i.filesQueue.pop()):(R.startNextQueue(e),R.onUploadCompleteAll(u,JSON.stringify(o)),i.uploading=!1)},onFail:e=>{R.onUploadError(u,String(e))}});R.sessions[e]=g,i.uploadCancelFn=g.cancel.bind(g),g.upload()},getUploadDetails(e,t,o){if(t.isShort||t.is_upload_clip_from_video){const t={file_size:e};return v.Ranges.isGroupId(o.oid)&&(t.group_id=Math.abs(o.oid)),(0,U.api)("shortVideo.create",t)}return new Promise(((i,n)=>{const a=(0,T.partConfigEnabled)("video_uploader_pass_params_for_logging")&&"add_video"===o?.act&&o?.oid&&o?.batchId?{batch_id:o.batchId}:null;return window.ajax.post("al_video.php?act=get_upload_url",{...a,file_size:e,user_agent:window.navigator.userAgent,owner_id:o.oid,tag:o.tag,from:o.from,extra_upload_options:t.extraUploadOptions},{onDone:e=>{i(e)},onFail:e=>{n(e)}})}))},uploadFileChunked:function(e,t,o){let i=this.options[e],n=R.getFileInfo(e,i,t);i.multi_sequence&&this.onUploadStart(n);let a={file:t,fileName:(t.name||t.fileName).replace(/[&<>"']/g,""),fileSize:t.size,fileMime:t.type,retryCount:0,timeouts:[],activeRequests:[],requestsProgress:{},pointer:0,state:{url:o,started:Date.now(),loaded:null,chunkSize:i.chunkSize||4194304,sessionId:(1e17*Math.random()).toString(16)}};a.abort=function(e){(0,s.each)(e.timeouts,(function(e,t){clearTimeout(t)})),(0,s.each)(e.activeRequests,(function(e,t){t.abort()})),e.timeouts=[],e.activeRequests=[]}.bind(null,a),a.chunksNum=Math.ceil(a.fileSize/a.state.chunkSize),a.chunksLeft=a.chunksNum;let r=function(e){a.storageKey=["upload",e,a.fileSize].join("_"),i.uploading=!0,i.chunkedUpload=a;let t=f.ls.get(a.storageKey);t&&(Date.now()-t.started<864e5?(a.state=t,o=t.url):f.ls.remove(a.storageKey));try{console.log("%c Warning: if devtools is logging network requests it may cause high memory usage during file upload","font-size:16px;color:orange;")}catch(e){}u()};const d=R.vars[e];function u(){for(a.pointer=0,a.chunksLeft=a.chunksNum;a.activeRequests.length<4&&a.pointer<a.fileSize;)p()}function p(){let e=a.pointer,t=Math.min(e+a.state.chunkSize,a.fileSize)-1;if(e>=a.fileSize)return;let o=!1;a.state.loaded&&(0,s.each)(a.state.loaded.split(","),(function(i,n){let s=n.match(/^(\d+)-(\d+)\/\d+$/),l=parseInt(s[1]),r=parseInt(s[2]);if(e>=l&&t<=r)return o=!0,a.chunksLeft-=Math.ceil((r+1-e)/a.state.chunkSize),a.pointer=r+1,!1})),o?(h(),p()):(c(e,t),a.pointer+=a.state.chunkSize)}function c(s,r){let d=(t.slice||t.webkitSlice||t.mozSlice).call(t,s,r+1),_=new XMLHttpRequest;_.open("POST",o,!0),_.upload.onprogress=function(e){_.readyState!==XMLHttpRequest.DONE&&(e.lengthComputable&&(a.requestsProgress[s]=e.loaded),h())},_.onload=function(d){var c;a.activeRequests.splice((0,l.indexOf)(a.activeRequests,d.target),1),a.retryCount=0,--a.chunksLeft,201==d.target.status?(a.chunksLeft?(a.state.loaded=d.target.responseText,f.ls.set(a.storageKey,a.state),p()):(a.state.loaded=d.target.responseText,f.ls.set(a.storageKey,a.state),u()),delete a.requestsProgress[s],h()):200==d.target.status?(f.ls.remove(a.storageKey),c=d.target.responseText,(0,l.extend)(n,R.getFileInfo(e,i,t)),R.options[e].filesLoadedSize+=a.fileSize,R.options[e].filesLoadedCount+=1,R.onUploadComplete(n,c),R.options[e].filesQueue&&R.options[e].filesQueue.length>0?R.uploadFile(e,R.options[e].filesQueue.pop(),o):(R.startNextQueue(e),R.onUploadCompleteAll(n,c),i.uploading=!1)):(f.ls.remove(a.storageKey),a.abort(),R.onUploadError(n),R.options[e].filesQueue.length||(R.startNextQueue(e),R.onUploadCompleteAll(n,d.target.responseText),i.uploading=!1),g(d.target.status,d.target.responseText,s+"-"+r))},_.onerror=function(e){if(a.activeRequests.splice((0,l.indexOf)(a.activeRequests,e.target),1),++a.retryCount<=50){let e=setTimeout(c.bind(null,s,r),300*a.retryCount);a.timeouts.push(e)}else a.abort(),R.onConnectionLost(n);h(),g(e.target.status,e.target.responseText,s+"-"+r)},_.setRequestHeader("X-Uploading-Mode","parallel"),_.setRequestHeader("Content-Disposition",'attachment, filename="'+encodeURI(a.fileName)+'"'),_.setRequestHeader("Content-Type",a.fileMime||"application/octet-stream"),_.setRequestHeader("Content-Range","bytes "+s+"-"+r+"/"+a.fileSize),_.setRequestHeader("Session-ID",a.state.sessionId),_.send(d),d=null,a.activeRequests.push(_)}function h(){let o=a.fileSize,r=(a.chunksNum-a.chunksLeft)*a.state.chunkSize;(0,s.each)(a.requestsProgress,(function(e,t){r+=t})),(0,l.extend)(n,R.getFileInfo(e,i,t)),i.multi_progress?R.onUploadProgress(n,r,o):R.onUploadProgress(e,Math.min(r+i.filesLoadedSize,i.filesTotalSize),i.filesTotalSize)}function g(e,t,i){window.ajax.post("al_video.php",{act:"uploadVideoFailStat",url:o,error:e+","+t,range:i,sessionId:a.state.sessionId,chunksLeft:a.chunksLeft,loaded:a.state.loaded})}window.ajax.post("al_video.php?act=get_upload_url",{file_size:t.size?t.size:0,user_agent:window.navigator.userAgent,owner_id:d.oid,tag:d.tag,from:d.from,extra_upload_options:i.extraUploadOptions},{onDone:function(s){a.state.url=s.upload_url,o=a.state.url,R.uploadUrls[e]=o,function(e,t){let o=1048576,i=Math.floor(e.size/2)-o/2,n=[e.slice(0,o),e.slice(i,i+o),e.slice(e.size-o,e.size)];!function e(o){let i=n.shift();if(!i)return void t(o);let a=new FileReader;a.addEventListener("loadend",(function(t){let i=new Uint8Array(t.target.result),n=function(){let e=65535,t=65535;return{append:o,result:i};function o(o){let i=o.length,n=0;for(;i;){let a=i>359?359:i;i-=a;do{t+=e+=o[n++]}while(--a);e=((65535&e)>>>0)+(e>>>16),t=((65535&t)>>>0)+(t>>>16)}}function i(){return e=((65535&e)>>>0)+(e>>>16),t=((65535&t)>>>0)+(t>>>16),(t<<16>>>0|e)>>>0}}();n.append(i),o+=n.result().toString(16),e(o)})),a.readAsArrayBuffer(i)}("")}(t,r),i.onUploadedVideoIdReceived&&i.onUploadedVideoIdReceived(n,s.video_id)},onFail:function(){R.terminateUpload(e,t.name)}})},isNeedRequestUrl:function(e){let t=this.options[e];return t.requestOptionsForFile&&"video"===t.type},getUploadOptions:function(e,t){let o=this.options[e],i=cur.gid||0;v.Ranges.isGroupId(cur.oid)&&(0,l.inArray)(cur.module,["public","groups","ads","app"])&&(0,l.inArray)(o.from,["article","post","ads"])&&(i=-cur.oid),R.options[e].uploadOptionsXhr=window.ajax.post("al_video.php?act=get_upload_params",{gid:i,from:o.from},{onDone:function(o){let i=(0,_.toQueryString)(o.vars),n=o.options.url+(o.options.url.match(/\?/)?"&":"?")+i;(0,l.extend)(R.options[e],o.options),(0,l.extend)(R.vars[e],o.vars),R.uploadUrls[e]=n,R.check(e),R.uploadFile(e,t,n,!0)},onFail:function(){R.terminateUpload(e,t.name)}})},uploadFile:function(e,t,o,i){let n=this.options[e];if(this.files[e]=t,R.isNeedRequestUrl(e)&&!i)return void R.getUploadOptions(e,t);if(n.chunked&&R.supportsChunkedUpload())return void this.uploadFileChunkedWithSDK(...arguments);let a=c.browser.msie&&(0,s.intval)(c.browser.version)<10?window.XDomainRequest:window.XMLHttpRequest,d=R.getFileInfo(e,n,t);n.multi_sequence&&this.onUploadStart(d),n.uploading=!0;let u=null;if(window.FormData){let i=new FormData;t instanceof File?i.append(n.file_name,t):i.append(n.file_name,t,t.filename.replace(/[&<>"']/g,"")),u=new a;let s=!0;u.open("POST",o,!0),u.onload=function(i){(0,l.extend)(d,R.getFileInfo(e,n,t)),R.options[e].filesLoadedSize+=t.size,R.options[e].filesLoadedCount+=1,R.onUploadComplete(d,i.target.responseText),R.options[e].filesQueue&&R.options[e].filesQueue.length>0?R.uploadFile(e,R.options[e].filesQueue.pop(),o):(R.startNextQueue(e),R.onUploadCompleteAll(d,i.target.responseText),n.uploading=!1)},u.onerror=function(i){(0,l.extend)(d,R.getFileInfo(e,n,t)),R.options[e].filesTotalSize-=t.size,R.options[e].filesTotalCount-=1,R.onUploadError(d,i.target.responseText),R.options[e].filesQueue.length>0?R.uploadFile(e,R.options[e].filesQueue.pop(),o):(R.startNextQueue(e),R.onUploadCompleteAll(d,i.target.responseText),n.uploading=!1)},u.upload.onprogress=function(o){u.readyState!==XMLHttpRequest.DONE&&(s=!1,(0,l.extend)(d,R.getFileInfo(e,n,t)),o.lengthComputable&&(n.multi_progress?R.onUploadProgress(d,o.loaded,o.total):R.onUploadProgress(e,Math.min(o.loaded+n.filesLoadedSize,n.filesTotalSize),n.filesTotalSize)))},u.send(i)}else{(0,r.saveStatlogEvents)({name:"upload_tmp_stat",value:1,keys:["window_formdata_not_exists"]});try{if(a&&!a.prototype.sendAsBinary&&window.ArrayBuffer&&window.Uint8Array){let e=window.MozBlobBuilder||window.WebKitBlobBuilder||window.BlobBuilder;e&&(a.prototype.sendAsBinary=function(t){let o=new window.ArrayBuffer(t.length),i=new Uint8Array(o,0);for(let e=0;e<t.length;e++)i[e]=255&t.charCodeAt(e);let n=new e;n.append(o);let a=n.getBlob();this.send(a)})}let i=new FileReader;i.onload=function(){u=new a,u.onload=function(i){(0,l.extend)(d,R.getFileInfo(e,n,t)),R.options[e].filesLoadedSize+=t.size,R.options[e].filesLoadedCount+=1,R.onUploadComplete(d,i.target.responseText),R.options[e].filesQueue.length>0?R.uploadFile(e,R.options[e].filesQueue.pop(),o):(R.startNextQueue(e),R.onUploadCompleteAll(d,i.target.responseText))},u.onerror=function(i){(0,l.extend)(d,R.getFileInfo(e,n,t)),R.options[e].filesTotalSize-=t.size,R.options[e].filesTotalCount-=1,R.onUploadError(d,i.target.responseText),R.options[e].filesQueue.length>0?R.uploadFile(e,R.options[e].filesQueue.pop(),o):(R.startNextQueue(e),R.onUploadCompleteAll(d,i.target.responseText),n.uploading=!1)},u.upload.onprogress=function(o){(0,l.extend)(d,R.getFileInfo(e,n,t)),o.lengthComputable&&(n.multi_progress?(R.onUploadProgress(d,o.loaded,o.total),n.uploading=!1):R.onUploadProgress(e,Math.min(o.loaded+n.filesLoadedSize,n.filesTotalSize),n.filesTotalSize))},u.open("POST",o,!0);let r="---------"+(0,s.irand)(1111111111,9999999999);u.setRequestHeader("Content-Type","multipart/form-data, boundary="+r);let p="--"+r+"\r\n";p+="Content-Disposition: form-data; name='"+n.file_name+"'; filename='"+t.name.replace(/[&<>"']/g,"")+"'\r\n",p+="Content-Type: application/octet-stream\r\n\r\n",p+=i.result+"\r\n",p+="--"+r+"--",u.sendAsBinary(p)},i.readAsBinaryString(t)}catch(e){try{console.error(e)}catch(e){}}}R.options[e].xhr=u},retryUpload(e){const t=R.sessions[e];t&&t.destroy(),this.uploadFileChunkedWithSDK(e,this.files[e])},terminateUpload:function(e,t,o){try{let n=R.vars[e],a=R.options[e],s=(0,_.toQueryString)(n),l=a.filesQueue,r=!1,d=a.multi_progress?{ind:e,fileName:t?.replace(/[&<>"']/g,"")}:e,u=t?e+"_"+t:e;for(let e in l)if(t==(l[e].fileName||l[e].name||"").replace(/[&<>"']/g,"")){l.splice(e,1),r=!0;break}o&&o.tt&&o.tt.destroy&&o.tt.destroy(),(0,i.re)("upload"+u+"_progress_wrap"),R.onUploadComplete(d,'{"error":"ERR_UPLOAD_TERMINATED: upload request was terminated"}'),!r&&a.uploadCancelFn&&a.uploadCancelFn();let p=this.uploadUrls[e]+(this.uploadUrls[e].match(/\?/)?"&":"?")+s;r||(l.length>0?R.uploadFile(e,l.pop(),p):(R.startNextQueue(e),R.onUploadCompleteAll(d,"")))}catch(e){try{console.error(e)}catch(e){}}},terminateAllUploads:function(){this.checked&&(0,s.each)(this.checked,(e=>{if(e=+e,!R.isSomethingUploading(e))return;let t=R.options[e];if(!t)return;let o="";t.filesQueue&&t.filesQueue.length&&(t.filesQueue=[]),t.xhr&&4!==t.xhr.readyState&&0!==t.xhr.readyState&&(o=t.file_name),t.chunked&&t.chunkedUpload&&t.chunkedUpload.activeRequests.length&&(o=t.chunkedUpload.fileName,this.terminateUpload(e,o)),o&&this.terminateUpload(e,o)}))},startNextQueue:function(e){if(void 0===cur.multiProgressIndex&&setTimeout((function(){delete cur.fileApiUploadStarted}),1e3),e!=cur.multiProgressIndex)return;if(this.options[e].multi_progress&&cur.nextQueues&&cur.nextQueues.length){let e=cur.nextQueues[0],t=R.options[e].filesQueue;for(cur.nextQueues.splice(0,1);0==t.length&&cur.nextQueues.length>0;)e=cur.nextQueues[0],cur.nextQueues.splice(0,1),t=R.options[e].filesQueue;if(t.length>0){let o=R.vars[e],i=(0,_.toQueryString)(o),n=R.uploadUrls[e]+(R.uploadUrls[e].match(/\?/)?"&":"?")+i;R.uploadFile(e,t.pop(),n),cur.multiProgressIndex=e}else delete cur.multiProgressIndex,setTimeout((function(){delete cur.fileApiUploadStarted}),1e3)}else delete cur.multiProgressIndex,setTimeout((function(){delete cur.fileApiUploadStarted}),1e3)},isFileDrag:function(e){if(!e||e.target&&("IMG"==e.target.tagName||"A"==e.target.tagName))return!1;if(!e.dataTransfer.types)return!0;for(let t=0;t<e.dataTransfer.types.length;t++)if("Files"==e.dataTransfer.types[t])return!0;return!1},dragEnter:function(e,t){cur.uploadDragStarted&&1!=cur.uploadDragStarted||(cur.uploadDragStarted=R.isFileDrag(t)?2:1),1!=cur.uploadDragStarted&&R.dropbox[e]?(setTimeout((function(){clearTimeout(R.dragTimer[e]),delete R.dragTimer[e]}),0),R.options[e].onDragEnter&&R.options[e].onDragEnter(t),(0,i.show)(R.dropbox[e]),(0,n.cancelEvent)(t)):(0,n.cancelEvent)(t)},dragOut:function(e,t){if(1==cur.uploadDragStarted||!R.dropbox[e])return void(0,n.cancelEvent)(t);R.dragTimer[e]&&(clearTimeout(R.dragTimer[e]),delete R.dragTimer[e]);const o=function(){const t=R.options[e],o=R.dropbox[e];t.visibleDropbox||(0,i.hide)(o),t.onDragOut&&t.onDragOut(),(0,i.removeClass)(o,"dropbox_over")};!t.clientX&&!t.clientY?o():R.dragTimer[e]=setTimeout(o,100),(0,n.cancelEvent)(t)},dragOver:function(e,t){if(1==cur.uploadDragStarted||!R.dropbox[e])return void(0,n.cancelEvent)(t);let o=R.insideDropbox(e,t);t.dataTransfer&&"copy"!==t.dataTransfer.dropEffect&&(t.dataTransfer.dropEffect=o?"copy":"none"),(0,i.toggleClass)(R.dropbox[e],"dropbox_over",o),(0,n.cancelEvent)(t)},drop:function(e){return(0,s.each)(R.dropbox,(function(t,o){o&&(R.insideDropbox(t,e)&&R.onFileApiSend(t,e.dataTransfer.files),R.options[t].visibleDropbox||(0,i.hide)(o),R.options[t].onDrop&&R.options[t].onDrop(),(0,i.removeClass)(o,"dropbox_over"))})),delete cur.uploadDragStarted,(0,n.cancelEvent)(e),!1},insideDropbox:function(e,t){let o=t.target;for(;o.parentNode;){if(o==R.dropbox[e])return!0;o=o.parentNode}return!1},isSomethingUploading:function(e){let t=R.options[e];return!!t&&(!(!t.filesQueue||!t.filesQueue.length)||(!(!t.xhr||4===t.xhr.readyState||0===t.xhr.readyState)||(!(!t.uploadOptionsXhr||4===t.uploadOptionsXhr.readyState||0===t.uploadOptionsXhr.readyState)||!!(t.chunked&&t.chunkedUpload&&t.chunkedUpload.activeRequests.length))))},flashCallbacks:function(){return{onUploadStart:R.onUploadStart,onUploadProgress:R.onUploadProgress,onUploadSuccess:R.onUploadComplete,onUploadComplete:R.onUploadCompleteAll,onUploadError:R.onUploadError,onDebug:R.onDebug,onMouseDown:R.buttonDown,onMouseUp:R.buttonUp,onMouseOver:R.buttonOver,onMouseOut:R.buttonOut,onSelectClick:R.onSelectClick}},sendUploadStat:function(e,t){let o=R.options[e],i=R.vars[e];if(o.signed||!o.error_hash)return;let n=(0,l.extend)({act:"stat",mid:i.mid,oid:i.oid,gid:i.gid,aid:i.aid,server:o.server,error:o.error,hash:o.error_hash},t);window.ajax.post("upload_fails.php",n)}}},395846:(e,t,o)=>{o.d(t,{ACCESS_DENIED_CODE:()=>_,CLIP_UPLOAD_MAX_FILE_SIZE_IN_GB:()=>d,SHORT_VIDEO_UPLOAD_EXTS:()=>n,SHORT_VIDEO_UPLOAD_INPUT_ACCEPT:()=>s,VIDEO_DEFAULT_THUMB_ID:()=>f,VIDEO_UPLOAD_CHUNK_MAX_RETRY_NUMBER:()=>c,VIDEO_UPLOAD_CHUNK_SIZE:()=>u,VIDEO_UPLOAD_EXTS:()=>a,VIDEO_UPLOAD_FILE_THREAD_NUMBER:()=>p,VIDEO_UPLOAD_INPUT_ACCEPT:()=>l,VIDEO_UPLOAD_MAX_FILE_SIZE_IN_GB:()=>r,VIDEO_UPLOAD_SUBTITLES_DISABLED:()=>h,VIDEO_UPLOAD_SUBTITLES_USER_LANG:()=>g});const i=e=>["video/*",...e.map((e=>`.${e}`))].join(","),n="avi mp4 3gp mpeg mov flv f4v wmv mkv webm vob rm rmvb m4v mpg ogv ts m2ts mts mxf".split(" "),a=[...n,"torrent"],s=i(n),l=i(a),r=5,d=8,u=4194304,p=4,c=10,h=-1,g=-2,f="0_0",_=15},615650:(e,t,o)=>{o.d(t,{ErrorCodes:()=>d,checkFileType:()=>r,getUploadErrorInfo:()=>p,getUploadErrorText:()=>u,getVideoMetadata:()=>l,sendVideoMetadataStatsBeforeUpload:()=>c});var i=o(866467),n=o(395846),a=o(314309),s=o(452223);function l(e){return new Promise((t=>{try{const o=document.createElement("video");o.preload="metadata",o.onloadedmetadata=()=>{const e=o.duration||0,i=o.videoWidth,n=o.videoHeight;t({duration:e,width:i,height:n})},o.onerror=()=>t(null),o.src=window.URL.createObjectURL(e)}catch(e){t(null)}}))}function r(e,t){const o=(e.name.split(".").pop()||"").toLowerCase(),i=(t||n.VIDEO_UPLOAD_EXTS).includes(o);return!!(e.type&&e.type.match(/^video/i)||i)}var d=function(e){return e[e.SHORT_VIDEO_TOO_SHORT=100]="SHORT_VIDEO_TOO_SHORT",e[e.SHORT_VIDEO_TOO_LONG=101]="SHORT_VIDEO_TOO_LONG",e[e.INCORRECT_PUBLISH_DATE=-1]="INCORRECT_PUBLISH_DATE",e[e.LIMIT_POSTPONE_POSTS=-2]="LIMIT_POSTPONE_POSTS",e[e.LIMIT_POSTPONE_POSTS_PER_DAY=-3]="LIMIT_POSTPONE_POSTS_PER_DAY",e[e.SAME_POSTPONE_POST_DATE=-4]="SAME_POSTPONE_POST_DATE",e[e.LIMIT_POSTS_PER_DAY=-5]="LIMIT_POSTS_PER_DAY",e[e.SHORT_VIDEO_CONVERT=20]="SHORT_VIDEO_CONVERT",e[e.CLAIMED_NOT_UPLOADED=15]="CLAIMED_NOT_UPLOADED",e}({});function u(e,t){switch(e){case 100:return(0,i.getLang)("video_upload_encode_error_too_short_1s");case 101:return(0,i.getLang)("video_upload_encode_error_too_long");case 20:return(0,i.getLang)("video_upload_error_uploading");case-1:return(0,i.getLang)("video_upload_error_incorrect_publish_date");case-2:return(0,i.getLang)("video_upload_error_limit_postpone_posts");case-3:return(0,i.getLang)("video_upload_error_day_limit_postpone_posts");case-4:return(0,i.getLang)("video_upload_error_same_publish_date");case-5:return(0,i.getLang)("video_upload_error_day_limit_posts");default:return t||(0,i.getLang)("global_unknown_error")}}function p(e){switch(e){case-2:return(0,i.getLang)("video_upload_error_info_limit_postpone_posts");case-3:return(0,i.getLang)("video_upload_error_info_day_limit_postpone_posts");case-4:return(0,i.getLang)("video_upload_error_info_same_publish_date")}}const c=async(e,t,o)=>{const i=await l(e);i?.duration&&i?.width&&a.videoUploadStatsCollector.logEvent({event_type:s.VideoUploadActionEventTypes.DECODE_VIDEO_METAINFO,video_owner_id:t,video_id:o,decode_metainfo:JSON.stringify({width:i.width,height:i.height,video_duration:i.duration,format:(e.name.split(".").pop()||"").toLowerCase()})})}},375512:(e,t,o)=>{o.d(t,{LogLevelEnum:()=>c,VideoUploadService:()=>O});var i,n=Object.defineProperty,a=Object.getOwnPropertySymbols,s=Object.prototype.hasOwnProperty,l=Object.prototype.propertyIsEnumerable,r=(e,t,o)=>t in e?n(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,d=(e,t)=>{for(var o in t||(t={}))s.call(t,o)&&r(e,o,t[o]);if(a)for(var o of a(t))l.call(t,o)&&r(e,o,t[o]);return e},u=(e,t,o)=>new Promise(((i,n)=>{var a=e=>{try{l(o.next(e))}catch(e){n(e)}},s=e=>{try{l(o.throw(e))}catch(e){n(e)}},l=e=>e.done?i(e.value):Promise.resolve(e.value).then(a,s);l((o=o.apply(e,t)).next())})),p=class{},c=((i=c||{})[i.NONE=0]="NONE",i[i.INFO=2]="INFO",i[i.WARN=4]="WARN",i[i.ERROR=8]="ERROR",i[i.DEBUG=16]="DEBUG",i),h=1048576;function g(){}function f(e){return new Promise(((t,o)=>{let i=Math.floor(e.size/2)-h/2,n=new Blob([e.slice(0,h),e.slice(i,i+h),e.slice(e.size-h,e.size)]),a=new FileReader;a.onload=function(e){t(function(e){let t=65535,o=65535,i=e.length,n=0;for(;i;){let a=i>359?359:i;i-=a;do{o+=t+=e[n++]}while(--a);t=((65535&t)>>>0)+(t>>>16),o=((65535&o)>>>0)+(o>>>16)}return t=((65535&t)>>>0)+(t>>>16),o=((65535&o)>>>0)+(o>>>16),((o<<16>>>0|t)>>>0).toString(16)}(new Uint8Array(e.target.result)))},a.onerror=()=>{o(new Error("Could not read binary data"))},a.readAsArrayBuffer(n)}))}function _(e,t,o){return[t,"upload",e,String(o)].filter((e=>!!e)).join("_")}function m(e){return e.split("?").pop().split("&").map((e=>e.split("="))).findIndex((e=>"expires"===e[0]&&+e[1]>Date.now()))>-1}var b=class{constructor(e){this.hash="",this.file=e}getChunk(e,t){return this.file.slice(e,t+1)}getName(){return this.file.name}getSize(){return this.file.size}getType(){return this.file.type}getHash(){return u(this,null,(function*(){if(this.hash)return Promise.resolve(this.hash);let e=yield f(this.file);return this.hash=e,e}))}},S=class{constructor(e,t,o){this.uploadedDataRangesStr="",this.progress=0,this.progressChangeCallback=g,this.dataSource=e,this.chunkSize=t,this.logger=o,this.chunkUploadMap=[];let i=Math.ceil(this.fileSize/this.chunkSize);for(let e=0;e<i;e++)this.chunkUploadMap.push(0)}get fileSize(){return this.dataSource.getSize()}getNextPayload(){let e=this.chunkUploadMap.findIndex((e=>0===e));return-1===e?null:this.getChunkPayload(e)}processChunkUploaderResponse(e,t,o){this.chunkUploadMap[e.index]=2;let i={status:t.status,statusText:t.statusText,requestHeaders:o,responseHeaders:t.getAllResponseHeaders(),responseText:t.responseText};switch(t.status){case 200:try{this.uploadedFileObject=JSON.parse(t.response)}catch(e){this.logger.error("Could not parse final chunk upload server response",i)}this.updateProgress();break;case 201:this.uploadedDataRangesStr=t.responseText||t.getResponseHeader("Range")||"";try{this.setUploadedBytes(this.uploadedDataRangesStr)}catch(t){this.logger.error(`Could not parse chunk #${e.index} upload server response`,i)}break;default:this.logger.warn(`Unsupported request status code ${t.status}`,{request:t})}}getProgress(){return this.progress}getChunkLeftNumber(){return this.chunkUploadMap.filter((e=>0===e)).length}getChunkLoadedNumber(){return this.chunkUploadMap.filter((e=>2===e)).length}getUploadedFileObject(){return this.uploadedFileObject}getUploadedDataRangesStr(){return this.uploadedDataRangesStr}setUploadedBytes(e=""){let t=this.parseStatString(e);this.updateChunkUploadMap(t),this.updateProgress()}onProgressChange(e){this.progressChangeCallback=e}clearUploadingState(){for(let e=0;e<this.chunkUploadMap.length;e++)1===this.chunkUploadMap[e]&&(this.chunkUploadMap[e]=0)}getChunkPayload(e){let t=e*this.chunkSize,o=(e+1)*this.chunkSize-1;o=Math.min(o,this.fileSize-1);let i=this.dataSource.getChunk(t,o);return this.chunkUploadMap[e]=1,{index:e,startByte:t,endByte:o,data:i}}updateChunkUploadMap(e){this.chunkUploadMap=this.chunkUploadMap.map(((t,o)=>1===t?1:e.find((e=>{let t=o*this.chunkSize,i=Math.min((o+1)*this.chunkSize,this.fileSize)-1;return t>=e[0]&&i<=e[1]}))?2:0))}updateProgress(){let e=this.chunkUploadMap.filter((e=>2===e)).length/this.chunkUploadMap.length*100;if(this.progress!==e){this.progress=e;try{this.progressChangeCallback(this.progress)}catch(e){this.logger.warn("Failed to execute onProgress callback",e)}}}parseStatString(e){return e.split(",").map((e=>{let t=e.split("/")[0].split("-");return[parseInt(t[0]),parseInt(t[1])]}))}},k={label:"",chunkSize:4194304,threadNumber:4,maxRetryNumber:10,debugMode:!1,logLevel:0,logger:null,headers:{},onRestored:g,onPrepared:g,onStart:g,onStop:g,onFail:g,onCancel:g,onSuccess:g,onChunkUploadSuccess:g,onChunkUploadError:g,onProgress:()=>{}},U={maxRetryNumber:10,headers:{},fileName:"",fileType:"",fileSize:0},C=class{constructor(e,t,o,i){this.failCallback=g,this.offlineCallback=g,this.chunkUploadSuccessCallback=g,this.chunkUploadErrorCallback=g,this.state=0,this.currentRequest=null,this.currentTry=0,this.lastTickStart=0,this.lastChunkUploadTime=0,this.$uid=C.instanceCount++,this.uploadUrl=e,this.uploadManager=t,this.options=this.normalizeOptions(o),this.logger=i}start(){return 1===this.state||(this.state=1,this.tick()),Promise.resolve()}stop(e=!1){return 0===this.state?Promise.resolve():new Promise((t=>{this.currentRequest&&e?(this.currentRequest.addEventListener("abort",(()=>{this.logger.debug(`Thread #${this.$uid}: Halted.`),this.state=0,this.currentRequest=null,t()})),this.currentRequest.abort()):(this.logger.debug(`Thread #${this.$uid}: Halted.`),this.state=0,t())}))}onFail(e){this.failCallback=e}onOffline(e){this.offlineCallback=e}onUploadSuccess(e){this.chunkUploadSuccessCallback=e}onUploadError(e){this.chunkUploadErrorCallback=e}tick(){if(1!==this.state)return;this.lastTickStart=Date.now(),this.currentTry=0;let e=this.uploadManager.getNextPayload();e?this.tryLoadChunk(e):this.state=0}tryLoadChunk(e){if(1!==this.state)return;let t=new XMLHttpRequest;this.currentRequest=t,t.open("POST",this.uploadUrl,!0);let o={};for(let e in this.options.headers)o[e]=this.options.headers[e];o["Content-Type"]=this.options.fileType||"application/octet-stream",o["X-Uploading-Mode"]="parallel",o["Content-Range"]=`bytes ${e.startByte}-${e.endByte}/${this.options.fileSize}`,this.options.fileName&&(o["Content-Disposition"]="attachment; filename="+encodeURIComponent(this.options.fileName));for(let e in o)t.setRequestHeader(e,o[e]);t.onload=this.handleLoad.bind(this,e,t,o),t.onerror=this.handleNetworkError.bind(this,e,t),t.ontimeout=this.handleNetworkError.bind(this,e,t),t.send(e.data)}retryLoadChunk(e,t){setTimeout((()=>{this.currentTry++,this.tryLoadChunk(e)}),t)}handleLoad(e,t,o){return u(this,null,(function*(){if(this.currentRequest=null,this.lastChunkUploadTime=Date.now()-this.lastTickStart,t.status>=200&&t.status<300)this.logger.debug(`Thread #${this.$uid}: Chunk ${e.index} (${e.startByte} - ${e.endByte} from ${this.options.fileSize}) uploaded`),this.uploadManager.processChunkUploaderResponse(e,t,o),this.chunkUploadSuccessCallback(d({},e)),1===this.state&&this.tick();else{try{this.chunkUploadErrorCallback(d({},e),t.status,t.responseText)}catch(e){this.logger.error("Failed to execute chunkUploadError callback",e)}let i=this.options.maxRetryNumber>0,n=this.currentTry>=this.options.maxRetryNumber,a={chunk:{index:e.index,size:e.endByte-e.startByte,uploadTime:this.lastChunkUploadTime},request:{requestHeaders:o},response:{status:t.status,statusText:t.statusText,responseHeaders:t.getAllResponseHeaders(),responseText:t.responseText}};415===t.status?(this.logger.error(`Thread #${this.$uid}: Failed to upload chunk ${e.index} - Unsupported file format - halting`,a),yield this.stop(),this.failCallback()):i&&n?(this.logger.error(`Thread #${this.$uid}: Failed to upload chunk ${e.index} - Max retry number exceeded (${this.options.maxRetryNumber})`,a),yield this.stop(),this.failCallback()):(this.logger.error(`Thread #${this.$uid}: Failed to upload chunk ${e.index}. Retrying in 500ms`,a),this.retryLoadChunk(e,500))}}))}handleNetworkError(e,t){return u(this,null,(function*(){this.chunkUploadErrorCallback(e,t.status,t.responseText),yield this.stop(),this.offlineCallback(this)}))}normalizeOptions(e={}){let t=d({},U);return Number.isInteger(e.maxRetryNumber)&&(t.maxRetryNumber=e.maxRetryNumber),e.headers&&(t.headers=d({},e.headers)),"string"==typeof e.fileName&&(t.fileName=e.fileName),"string"==typeof e.fileType&&(t.fileType=e.fileType),Number.isInteger(e.fileSize)&&(t.fileSize=e.fileSize),t}},v=C;v.instanceCount=0;var y=class extends p{constructor(){super(...arguments),this.info=console.log.bind(console),this.warn=console.warn.bind(console),this.error=console.error.bind(console),this.debug=console.debug.bind(console)}},w=()=>{},x=class extends p{constructor(){super(...arguments),this.info=w,this.warn=w,this.error=w,this.debug=w}},T=class{static createLogger(e){return e?new y:new x}},E=class{constructor(e,t){this.uploadInfo=null,this.logger=e,this.logLevel=t}setUploadInfo(e){this.uploadInfo=e}info(e,t=null){2&this.logLevel&&this.logger.info(e,t,this.uploadInfo)}warn(e,t=null){4&this.logLevel&&this.logger.warn(e,t,this.uploadInfo)}error(e,t=null){8&this.logLevel&&this.logger.error(e,t,this.uploadInfo)}debug(e,t=null){16&this.logLevel&&this.logger.debug(e,t,this.uploadInfo)}},P=class{constructor(e,t,o){this.onRestoredCallback=g,this.onPreparedCallback=g,this.onStartCallback=g,this.onStopCallback=g,this.onFailCallback=g,this.onCancelCallback=g,this.onProgressCallback=g,this.onSuccessCallback=g,this.onChunkUploadSuccessCallback=g,this.onChunkUploadErrorCallback=g,this.state=0,this.key="",this.$uid=P.instanceCount++,this.chunkUploaderPool=[],this.uploadUrlObject=e,this.options=this.normalizeOptions(o),this.logger=new E(this.options.logger||T.createLogger(this.options.debugMode),this.options.logLevel),this.options.onRestored!==g&&this.onRestored(this.options.onRestored),this.options.onPrepared!==g&&this.onPrepared(this.options.onPrepared),this.options.onStart!==g&&this.onStart(this.options.onStart),this.options.onStop!==g&&this.onStop(this.options.onStop),this.options.onCancel!==g&&this.onCancel(this.options.onCancel),this.options.onFail!==g&&this.onFail(this.options.onFail),this.options.onProgress!==g&&this.onProgress(this.options.onProgress),this.options.onSuccess!==g&&this.onSuccess(this.options.onSuccess),this.options.onChunkUploadSuccess!==g&&this.onChunkUploadSuccess(this.options.onChunkUploadSuccess),this.options.onChunkUploadError!==g&&this.onChunkUploadError(this.options.onChunkUploadError),this.dataSource=new b(t),this.uploadManager=new S(this.dataSource,this.options.chunkSize,this.logger),this.uploadManager.onProgressChange(this.onProgressChangeHandler.bind(this)),this.uploadPromise=new Promise(((e,t)=>{this.uploadResolveHandler=e,this.uploadRejectHandler=t})),this.logger.info("UploadSession: instance created and configured with following options:",this.options)}get timerName(){return`${this.dataSource.getName()} uploaded in`}upload(){return u(this,null,(function*(){return 0===this.state&&(yield this.prepare()),1===this.state&&(yield this.start()),this.uploadPromise}))}start(){return u(this,null,(function*(){switch(0===this.state&&(yield this.prepare()),this.state){case 1:this.logger.info("UploadSession: Starting uploading process"),window.console.time(this.timerName);break;case 3:this.logger.info("UploadSession: Resuming uploading process");break;default:return this}return this.onProgressCallback(this.uploadManager.getProgress()),this.state=2,yield Promise.all(this.chunkUploaderPool.map((e=>e.start()))),this.onStartCallback(),this}))}stop(e=!1){return u(this,null,(function*(){return 2!==this.state||(yield Promise.all(this.chunkUploaderPool.map((t=>t.stop(e)))),this.state=3,this.uploadManager.clearUploadingState(),this.onStopCallback()),this}))}cancel(){return u(this,null,(function*(){return 4===this.state||5===this.state||6===this.state||(this.logger.info("UploadSession: Cancelling uploading process..."),yield this.stop(!0),this.onCancelCallback(),this.uploadRejectHandler(new Error("Uploading was cancelled")),this.clearSessionData()),this}))}destroy(){this.stop(!0),this.uploadUrlObject="",this.logger=new E(T.createLogger(!1),0),this.uploadPromise&&this.uploadPromise,this.uploadResolveHandler=g,this.uploadRejectHandler=g,this.uploadPromise=Promise.reject(),this.onRestoredCallback=g,this.onPreparedCallback=g,this.onStartCallback=g,this.onStopCallback=g,this.onFailCallback=g,this.onCancelCallback=g,this.onProgressCallback=g,this.onSuccessCallback=g,this.onChunkUploadSuccessCallback=g,this.onChunkUploadErrorCallback=g,this.uploadManager.onProgressChange(g)}onRestored(e){return this.onRestoredCallback=e,this}onPrepared(e){return this.onPreparedCallback=e,this}onStart(e){return this.onStartCallback=e,this}onStop(e){return this.onStopCallback=e,this}onFail(e){return this.onFailCallback=e,this}onCancel(e){return this.onCancelCallback=e,this}onProgress(e){return this.onProgressCallback=e,this}onSuccess(e){return this.onSuccessCallback=e,this}onChunkUploadSuccess(e){return this.onChunkUploadSuccessCallback=e,this}onChunkUploadError(e){return this.onChunkUploadErrorCallback=e,this}getUploadUrl(){return this.uploadUrl}getChunkLeftNumber(){return this.uploadManager.getChunkLeftNumber()}getChunkLoadedNumber(){return this.uploadManager.getChunkLoadedNumber()}getLoadedRangesStr(){return this.uploadManager.getUploadedDataRangesStr()}prepare(){return u(this,null,(function*(){this.key=yield this.createUploadSessionKey(this.options.label),this.logger.info("UploadSession: UploadSession calculated key",this.key);let e=function(e){try{let t=localStorage.getItem(e);return t?JSON.parse(t):null}catch(e){return null}}(this.key);e&&m(e.url)?(this.logger.info("UploadSession: Found stored session for this file",e),this.uploadUrl=e.url,this.uploadManager.setUploadedBytes(e.loaded)):(this.uploadUrl=yield this.resolveUploadUrl(this.uploadUrlObject),this.logger.info("UploadSession: Resolved upload url",this.uploadUrl));let t={};new URL(this.uploadUrl).searchParams.forEach(((e,o)=>{t[o]=e})),this.logger.setUploadInfo({uploadParams:t,progress:this.uploadManager.getProgress(),video:{id:`${t.vkUserId}_${t.vkVideoId}`,name:this.dataSource.getName(),type:this.dataSource.getType(),size:this.dataSource.getSize()}});for(let e=0;e<this.options.threadNumber;e++)this.chunkUploaderPool.push(this.createChunkUploader(this.uploadUrl));this.saveSessionData(),this.state=1,this.onPreparedCallback()}))}resolveUploadUrl(e){switch(typeof e){case"string":return Promise.resolve(e);case"function":return e();default:throw new Error("UploadSession: Unsupported upload url object")}}createUploadSessionKey(e){return u(this,null,(function*(){return _(yield this.dataSource.getHash(),e,this.dataSource.getSize())}))}saveSessionData(){let e={url:this.uploadUrl,loaded:this.uploadManager.getUploadedDataRangesStr()};try{localStorage.setItem(this.key,JSON.stringify(e))}catch(e){this.logger.error("UploadSession: Could not save session data")}}clearSessionData(){try{localStorage.removeItem(this.key)}catch(e){this.logger.error("UploadSession: Could not remove session data")}}createChunkUploader(e){let t={maxRetryNumber:this.options.maxRetryNumber,headers:this.options.headers,fileSize:this.dataSource.getSize(),fileName:this.dataSource.getName(),fileType:this.dataSource.getType()},o=new v(e,this.uploadManager,t,this.logger);return o.onOffline(this.onThreadOfflineHandler.bind(this)),o.onFail(this.onThreadFailedHandler.bind(this)),o.onUploadSuccess(this.onChunkUploadSuccessHandler.bind(this)),o.onUploadError(this.onChunkUploadErrorHandler.bind(this)),o}onThreadOfflineHandler(e){return u(this,null,(function*(){this.logger.warn(`UploadSession: Thread #${e.$uid} went offline: Switching to ping mode...`),yield this.stop(!0),yield this.ping(),this.logger.warn("UploadSession: Connection renewed: Proceed upload process"),yield this.start()}))}onThreadFailedHandler(){return u(this,null,(function*(){yield this.stop(!0),this.onFailCallback(),this.uploadRejectHandler()}))}onChunkUploadErrorHandler(e,t,o){return u(this,null,(function*(){this.onChunkUploadErrorCallback(e,t,o)}))}onChunkUploadSuccessHandler(e){return u(this,null,(function*(){this.onChunkUploadSuccessCallback(e)}))}onProgressChangeHandler(e){if(this.onProgressCallback(e),this.saveSessionData(),100===e){window.console.timeEnd(this.timerName);let e=this.uploadManager.getUploadedFileObject();this.onSuccessCallback(e),this.uploadResolveHandler(e),this.clearSessionData()}}getUploadedRanges(){return u(this,null,(function*(){return new Promise(((e,t)=>{let o=new XMLHttpRequest;o.open("GET",this.uploadUrl,!0),o.onload=()=>{o.status>=200&&o.status<300?e(o.responseText):t()},o.onerror=t,o.ontimeout=t,o.send(null)}))}))}ping(){return 6===this.state?Promise.reject():new Promise((e=>{this.getUploadedRanges().then((()=>{e()})).catch((()=>{this.retryPing(e)}))}))}retryPing(e){setTimeout((()=>{this.ping().then(e).catch((()=>{this.retryPing(e)}))}),1e4)}normalizeOptions(e={}){let t=d({},k);if(e.label&&(t.label=String(e.label)),Number.isInteger(e.chunkSize)&&(t.chunkSize=e.chunkSize),Number.isInteger(e.threadNumber)&&(t.threadNumber=e.threadNumber),Number.isInteger(e.maxRetryNumber)&&(t.maxRetryNumber=e.maxRetryNumber),e.headers&&(t.headers=d({},e.headers)),"function"==typeof e.onRestored&&(t.onRestored=e.onRestored),"function"==typeof e.onPrepared&&(t.onPrepared=e.onPrepared),"function"==typeof e.onStart&&(t.onStart=e.onStart),"function"==typeof e.onStop&&(t.onStop=e.onStop),"function"==typeof e.onCancel&&(t.onCancel=e.onCancel),"function"==typeof e.onFail&&(t.onFail=e.onFail),"function"==typeof e.onProgress&&(t.onProgress=e.onProgress),"function"==typeof e.onSuccess&&(t.onSuccess=e.onSuccess),"function"==typeof e.onChunkUploadSuccess&&(t.onChunkUploadSuccess=e.onChunkUploadSuccess),"function"==typeof e.onChunkUploadError&&(t.onChunkUploadError=e.onChunkUploadError),Number.isInteger(e.logLevel)&&(t.logLevel=e.logLevel),e.logger){if(!(e.logger.info&&"function"==typeof e.logger.info&&e.logger.warn&&"function"==typeof e.logger.warn&&e.logger.error&&"function"==typeof e.logger.error&&e.logger.debug&&"function"==typeof e.logger.debug))throw new Error("Invalid logger provided. Logger MUST implement 4 methods: info(), warn(), error(), debug()");t.logger=e.logger}return!0===e.debugMode&&(t.logLevel=16),Object.hasOwnProperty.call(e,"debugMode")&&window.console.warn('Config property "debugMode" is deprecated and will be removed. Use "logLevel" property'),t}},L=P;L.instanceCount=0;var O=new class{constructor(){this.sessionList=[],window.addEventListener("online",(()=>{this.startAllUploadSessions()})),window.addEventListener("offline",(()=>{this.stopAllUploadSessions(!0)}))}createUploadSession(e,t,o){let i=new L(e,t,o);return this.sessionList.push(i),i}getFileUploadSession(e,t=""){return u(this,null,(function*(){let o=_(yield f(e),t,e.size);return this.sessionList.find((e=>e.key===o))}))}startAllUploadSessions(){return u(this,null,(function*(){yield Promise.all(this.sessionList.map((e=>e.start())))}))}stopAllUploadSessions(e=!1){return u(this,null,(function*(){yield Promise.all(this.sessionList.map((t=>t.stop(e))))}))}getStoredUploadSessionDataList(){try{return Object.keys(localStorage).filter((e=>/^upload_[A-Za-z0-9]+_\d+$/.test(e))).map((e=>JSON.parse(localStorage.getItem(e))))}catch(e){return[]}}clearExpiredUploadSessionsData(){try{Object.keys(localStorage).filter((e=>/^upload_[A-Za-z0-9]+_\d+$/.test(e))).map((e=>{let t=JSON.parse(localStorage.getItem(e));m(t.url)||localStorage.removeItem(t.lsKey)}))}catch(e){}}}}}]),"undefined"!=typeof window&&window.stManager?.done?.("dist/web/chunks/bfca7c35.68d44c0f.js")}catch(e){throw"undefined"!=typeof window&&window.stManager?.fail?.("dist/web/chunks/bfca7c35.68d44c0f.js",e),e}